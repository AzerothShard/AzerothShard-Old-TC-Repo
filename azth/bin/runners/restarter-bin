#!/bin/bash

source ./config.dist

function checkStatus() {
        if [ -d "/proc/"$1 ]; then
                eval "TEST=1"
        else
                eval "TEST=0"
        fi
}


function run() {
    TRACE_BEGIN_STRING="SIGSEGV"
    TRACE_FILE="$LOGS_PATH/"$SCREEN_NAME"_trace.log"
    ERR_FILE="$LOGS_PATH/"$SCREEN_NAME"_error.log"
    SYSLOG="$LOGS_PATH/"$SCREEN_NAME"_system.log"
    SYSERR="$LOGS_PATH/"$SCREEN_NAME"_system.err"
    LINKS_FILE="$LOGS_PATH/"$SCREEN_NAME"_crash_links.link"

    while :
    do
            PID=$(cat $SERVERPID)
            checkStatus $PID
            if [ $TEST -eq 0 ]; then
                    DATE=$(date)
                    echo "Restarting $SCREEN_NAME Core blizz($DATE)"
                    if [ $GDB_ENABLED -eq 1 ]; then
                            echo "GDB enabled"
                            grep -B 10 -A 1800 "$TRACE_BEGIN_STRING" "$SYSLOG" >> "$TRACE_FILE"
                            #echo "------------------`date+%Y-%m-%d-%H-%M-%S`------------------" >> "$TRACE_FILE"
                            cat "$SYSERR" > "$ERR_FILE"
                            screen -A -m -d -S $SCREEN_NAME ./start $SERVERBIN $GDB "$CONFIG" "$SYSLOG" "$SYSERR" 1
                    fi

                    if [ $GDB_ENABLED -eq 0 ]; then
                            echo "GDB disabled"
                            screen -A -m -d -S $SCREEN_NAME ./start $SERVERBIN null "$CONFIG" null null 0
                    fi
            fi

            sleep 15
    done
}
